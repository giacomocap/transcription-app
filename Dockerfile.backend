# Use an official Node.js runtime as a parent image
FROM node:22

# Install ffmpeg
RUN apt-get update && apt-get install -y ffmpeg

# Set the working directory
WORKDIR /app

# Copy package.json and package-lock.json
COPY backend/package*.json ./

# Install dependencies including typescript and ts-node globally
RUN npm install
RUN npm install -g typescript ts-node nodemon

# Copy prisma schema files
COPY backend/prisma ./prisma/

# Generate Prisma Client
RUN npx prisma generate

# Copy the rest of the backend code
COPY backend/ ./

# Create a production build
RUN npm run build

# Make sure the build succeeded
RUN test -f dist/index.js && test -f dist/worker.js

# Copy entrypoint script
COPY backend/docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Expose the port
EXPOSE 5001

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]

# The command will be overridden by docker-compose
CMD ["npm", "start"]